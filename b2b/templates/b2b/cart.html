{% extends "b2b/base.html" %}
{% block content %}
<h2>Кошик</h2>
{% if error %}<p style="color:red">{{ error }}</p>{% endif %}
{% if order %}
<table>
  <tr><th>Фото</th><th>SKU</th><th>Назва</th><th>К-сть</th><th>Ціна</th><th>Сума</th><th></th></tr>
  {% for i in order.items.all %}
  <tr>
    <td style="width:90px;">
      {% with img=i.variant.image_url|default:i.product.main_image_url %}
        {% if img %}<img src="{{ img }}" alt="" style="height:70px;object-fit:contain">{% endif %}
      {% endwith %}
    </td>
    <td>
      {{ i.product.sku }}
      {% if i.variant and i.variant.sku %}<div style="font-size:12px;color:#666">({{ i.variant.sku }})</div>{% endif %}
    </td>
    <td>
      {% if i.variant %}{{ i.variant.name_with_weight }}{% else %}{{ i.product.name_with_weight }}{% endif %}
      {% if i.variant_attrs %}
        <div style="font-size:12px;color:#555">
          {% for k, v in i.variant_attrs.items %} {{ k }}: {{ v }}{% if not forloop.last %}; {% endif %}{% endfor %}
        </div>
      {% endif %}
    </td>
    <td class="right">
      <form method="post" action="{% url 'b2b:cart_update_item' i.id %}" style="display:inline">
        {% csrf_token %}<input type="hidden" name="op" value="dec">
        <button class="btn" type="submit">−</button>
      </form>
      <span style="display:inline-block; width:40px; text-align:center">{{ i.qty }}</span>
      <form method="post" action="{% url 'b2b:cart_update_item' i.id %}" style="display:inline">
        {% csrf_token %}<input type="hidden" name="op" value="inc">
        <button class="btn" type="submit">+</button>
      </form>
    </td>
    <td class="right">{{ i.price }}</td>
    <td class="right">{{ i.line_total }}</td>
    <td>
      <form method="post" action="{% url 'b2b:cart_remove_item' i.id %}">
        {% csrf_token %}
        <button class="btn" type="submit">Видалити</button>
      </form>
    </td>
  </tr>
  {% endfor %}
  <tr><td colspan="5" class="right"><strong>Разом:</strong></td><td class="right"><strong>{{ order.total }}</strong></td><td></td></tr>
</table>

<div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
  <form method="post" action="{% url 'b2b:submit_order' %}">
    {% csrf_token %}<button class="btn" type="submit">Надіслати замовлення</button>
  </form>
  <form method="post" action="{% url 'b2b:cart_clear' %}" onsubmit="return confirm('Очистити кошик?');">
    {% csrf_token %}
    <button class="btn" type="submit">Очистити кошик</button>
  </form>
  <a class="btn" href="{% url 'b2b:product_list' %}">Продовжити покупки</a>
</div>
{% else %}
<p>Кошик порожній.</p>
{% endif %}
{% endblock %}

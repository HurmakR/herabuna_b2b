{% extends "b2b/base.html" %}
{% block content %}
<h2>Каталог</h2>

{% if request.user.is_staff %}
  <p><a class="btn" href="{% url 'b2b:orders_admin' %}">Управління замовленнями</a></p>
{% endif %}

<form method="get" style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:12px;">
  <div>
    <label>Пошук</label><br>
    <input type="text" name="q" value="{{ q }}" placeholder="Назва або SKU" style="min-width:260px">
  </div>
  <div>
    <label>Категорія</label><br>
    <select name="cat">
      <option value="">-- всі --</option>
      {% for c in categories %}
        <option value="{{ c.id }}" {% if selected_cat == c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Бренд</label><br>
    <select name="brand">
      <option value="">-- всі --</option>
      {% for b in brands %}
        <option value="{{ b.id }}" {% if selected_brand == b.id %}selected{% endif %}>{{ b.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Сортування</label><br>
    <select name="sort">
      <option value="">За назвою</option>
      <option value="price_asc"  {% if sort == 'price_asc' %}selected{% endif %}>Ціна ↑</option>
      <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Ціна ↓</option>
      <option value="stock_asc"  {% if sort == 'stock_asc' %}selected{% endif %}>Наявність ↑</option>
      <option value="stock_desc" {% if sort == 'stock_desc' %}selected{% endif %}>Наявність ↓</option>
    </select>
  </div>
  <div>
    <button class="btn" type="submit">Фільтрувати</button>
    <a class="btn" href="{% url 'b2b:product_list' %}">Скинути</a>
  </div>
</form>

<table>
  <tr><th>Фото</th><th>SKU</th><th>Назва</th><th>Ціна гурт, грн</th><th>Наявність</th><th></th></tr>
  {% for p in products %}
  <tr>
    <td style="width:110px;">
      {% if p.main_image_url %}
        <a href="{% url 'b2b:product_detail' p.id %}"><img src="{{ p.main_image_url }}" alt="" style="height:100px;object-fit:contain"></a>
      {% endif %}
    </td>
    <td>{{ p.sku }}</td>
    <td>
      <a href="{% url 'b2b:product_detail' p.id %}">{{ p.name_with_weight }}</a>
      {% if p.categories.all %}
        <div style="font-size:12px;color:#666">
          {% for c in p.categories.all %} {{ c.name }}{% if not forloop.last %},{% endif %}{% endfor %}
        </div>
      {% endif %}
      {% if p.brand %}<div style="font-size:12px;color:#666">Бренд: {{ p.brand.name }}</div>{% endif %}
    </td>

    {% if request.user.is_staff %}
      {# ---- ADMIN ROW (single form) ---- #}
      <td class="right">
        <span class="view">{{ p.wholesale_price }}</span>
        <input class="edit" style="display:none; width:90px; text-align:right"
               type="number" step="0.01" name="wholesale_price" value="{{ p.wholesale_price }}"
               form="edit-form-{{ p.id }}">
      </td>
      <td class="right">
        <span class="view">{{ p.stock_qty }}</span>
        <input class="edit" style="display:none; width:70px; text-align:right"
               type="number" name="stock_qty" value="{{ p.stock_qty }}"
               form="edit-form-{{ p.id }}">
      </td>
      <td>
        <div class="view">
          <label style="font-size:12px;margin-right:8px;">
            <input type="checkbox" disabled {% if p.is_active %}checked{% endif %}> активний
          </label>
          <button class="btn row-edit" data-id="{{ p.id }}">Редагувати</button>
        </div>
        <form id="edit-form-{{ p.id }}" method="post" action="{% url 'b2b:product_update_inline' p.id %}" class="edit" style="display:none; gap:6px; align-items:center;">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <label style="font-size:12px;margin-right:8px;">
            <input type="checkbox" name="is_active" {% if p.is_active %}checked{% endif %}> активний
          </label>
          <button class="btn" type="submit">Зберегти</button>
          <button class="btn row-cancel" type="button" data-id="{{ p.id }}">Скасувати</button>
        </form>
      </td>
    {% else %}
      {# ---- DEALER ROW ---- #}
      <td class="right">{{ p.wholesale_price }}</td>
      <td class="right">{{ p.stock_qty }}</td>
      <td>
        {% if p.variants.all %}
          <a class="btn" href="{% url 'b2b:product_detail' p.id %}?next={{ request.get_full_path|urlencode }}">Обрати опції</a>
        {% else %}
          {% if p.stock_qty|default:0 > 0 %}
            <form method="post" action="{% url 'b2b:add_to_cart' p.id %}" class="qtyform" style="display:flex;gap:6px;align-items:center;">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <div class="qtybox" style="display:flex;align-items:center;border:1px solid #ccc;border-radius:6px;overflow:hidden;">
                <button type="button" class="qminus" style="padding:6px 10px;border:none;background:#eee">−</button>
                <input type="number" name="qty" value="1" min="1" max="{{ p.stock_qty }}" style="width:56px;text-align:center;border:none">
                <button type="button" class="qplus" style="padding:6px 10px;border:none;background:#eee">+</button>
              </div>
              <button class="btn" type="submit">Додати</button>
            </form>
          {% else %}
            <span style="color:#888">Немає в наявності</span>
          {% endif %}
        {% endif %}
      </td>
    {% endif %}
  </tr>
  {% empty %}
  <tr><td colspan="6">Нічого не знайдено.</td></tr>
  {% endfor %}
</table>

{% if not request.user.is_staff %}
<script>
document.querySelectorAll('.qtyform').forEach(function(form) {
  const minus = form.querySelector('.qminus');
  const plus = form.querySelector('.qplus');
  const input = form.querySelector('input[name="qty"]');
  const max = parseInt(input.getAttribute('max') || '999999', 10);
  if (minus && plus && input) {
    minus.addEventListener('click', function() {
      const v = Math.max(1, parseInt(input.value || '1', 10) - 1);
      input.value = v;
    });
    plus.addEventListener('click', function() {
      const v = Math.min(max, Math.max(1, parseInt(input.value || '1', 10) + 1));
      input.value = v;
    });
    input.addEventListener('input', function() {
      let v = parseInt(input.value || '1', 10);
      if (isNaN(v) || v < 1) v = 1;
      if (v > max) v = max;
      input.value = v;
    });
  }
});
</script>
{% else %}
<script>
document.querySelectorAll('.row-edit').forEach(btn => {
  btn.addEventListener('click', () => {
    const tr = btn.closest('tr');
    tr.querySelectorAll('.view').forEach(el => el.style.display = 'none');
    tr.querySelectorAll('.edit').forEach(el => el.style.display = (el.tagName === 'FORM' ? 'flex' : 'inline-block'));
  });
});
document.querySelectorAll('.row-cancel').forEach(btn => {
  btn.addEventListener('click', () => {
    const tr = btn.closest('tr');
    tr.querySelectorAll('.edit').forEach(el => el.style.display = 'none');
    tr.querySelectorAll('.view').forEach(el => el.style.display = '');
  });
});
</script>
{% endif %}
{% endblock %}

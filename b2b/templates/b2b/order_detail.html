{% extends "b2b/base.html" %}
{% block content %}
<h2>Замовлення № {{ order.id }}</h2>
<p>Статус: <strong>{{ order.get_status_display }}</strong></p>

<table>
  <tr><th>Фото</th><th>SKU</th><th>Назва</th><th>К-сть</th><th>Ціна</th><th>Сума</th></tr>
  {% for i in order.items.all %}
  <tr>
    <td style="width:90px;">
      {% with img=i.variant.image_url|default:i.product.main_image_url %}
        {% if img %}<img src="{{ img }}" alt="" style="height:70px;object-fit:contain">{% endif %}
      {% endwith %}
    </td>
    <td>
      {{ i.product.sku }}
      {% if i.variant and i.variant.sku %}<div style="font-size:12px;color:#666">({{ i.variant.sku }})</div>{% endif %}
    </td>
    <td>
      {% if i.variant %}{{ i.variant.name_with_weight }}{% else %}{{ i.product.name_with_weight }}{% endif %}
      {% if i.variant_attrs %}
        <div style="font-size:12px;color:#555">
          {% for k, v in i.variant_attrs.items %} {{ k }}: {{ v }}{% if not forloop.last %}; {% endif %}{% endfor %}
        </div>
      {% endif %}
    </td>
    <td class="right">{{ i.qty }}</td>
    <td class="right">{{ i.price }}</td>
    <td class="right">{{ i.line_total }}</td>
  </tr>
  {% endfor %}
  <tr><td colspan="5" class="right"><strong>Разом:</strong></td><td class="right"><strong>{{ order.total }}</strong></td></tr>
</table>

<p style="margin-top:10px;">
  {% if order.status != 'draft' and order.status != 'cancelled' %}
    <a class="btn" href="{% url 'b2b:invoice_pdf' order.id %}">Рахунок</a>
    <a class="btn" href="{% url 'b2b:waybill_pdf' order.id %}">Накладна</a>
  {% endif %}
  {% if request.user.is_staff and order.status == 'shipped' and order.shipping_ttn %}
    <a class="btn" href="{% url 'b2b:order_np_label' order.id %}">Етикетка 10×10</a>
  {% endif %}
</p>



{# Show delete button only for non-staff and only when status is draft or cancelled #}
{% if not request.user.is_staff %}
  {% if order.status == 'draft' or order.status == 'cancelled' %}
    <form method="post" action="{% url 'b2b:order_delete' order.id %}" onsubmit="return confirm('Видалити це замовлення?');">
      {% csrf_token %}
      <button class="btn" type="submit">Видалити замовлення</button>
    </form>
  {% endif %}
{% endif %}
{% endblock %}

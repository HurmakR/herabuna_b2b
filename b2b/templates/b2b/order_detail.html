{% extends "b2b/base.html" %}
{% block title %}Замовлення #{{ order.id }} — Herabuna B2B{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h4 mb-0">Замовлення #{{ order.id }}</h2>
  <span class="badge text-bg-secondary">{{ order.get_status_display }}</span>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Клієнт</div>
      <div class="card-body">
        <div>{{ order.dealer.username }}{% if order.dealer.company_name %}, {{ order.dealer.company_name }}{% endif %}</div>
        <div class="small text-muted">
          {% if order.dealer.email %}{{ order.dealer.email }}{% endif %}
          {% if order.dealer.phone %} • {{ order.dealer.phone }}{% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Доставка (Нова Пошта)</div>
      <div class="card-body">
        <div>{{ order.shipping_city }}</div>
        <div class="small text-muted">{{ order.shipping_warehouse }}</div>
        <div class="small mt-2">Одержувач: {{ order.shipping_recipient }} ({{ order.shipping_phone }})</div>
        {% if order.shipping_ttn %}
          <div class="mt-2">ТТН: <span class="fw-semibold">{{ order.shipping_ttn }}</span></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="table-responsive mb-3">
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Фото</th>
        <th>SKU</th>
        <th>Товар</th>
        <th class="text-end">К-сть</th>
        <th class="text-end">Ціна</th>
        <th class="text-end">Сума</th>
      </tr>
    </thead>
    <tbody>
      {% for i in order.items.all %}
      <tr>
        <td style="width:90px">
          {% with img=i.variant.image_url|default:i.product.main_image_url %}
            {% if img %}<img src="{{ img }}" alt="" style="height:70px; object-fit:contain">{% endif %}
          {% endwith %}
        </td>
        <td>{{ i.product.sku }}</td>
        <td>{% if i.variant %}{{ i.variant.name_with_weight }}{% else %}{{ i.product.name_with_weight }}{% endif %}</td>
        <td class="text-end">{{ i.qty }}</td>
        <td class="text-end">{{ i.price }}</td>
        <td class="text-end">{{ i.line_total }}</td>
      </tr>
      {% endfor %}
      <tr>
        <td colspan="5" class="text-end fw-semibold">Разом:</td>
        <td class="text-end fw-bold">{{ order.total }}</td>
      </tr>
    </tbody>
  </table>
</div>

<p class="d-flex flex-wrap gap-2">
{% if order.status != 'draft' and order.status != 'cancelled' and order.status != 'submitted' %}
  <div class="d-flex flex-wrap gap-2 my-2">
    <a class="btn btn-outline-primary btn-sm" href="{% url 'b2b:invoice_print' order.id %}">Рахунок</a>
    <a class="btn btn-outline-primary btn-sm" href="{% url 'b2b:waybill_print' order.id %}">Накладна</a>

    {# для відвантажених: етикетка НП (залишаємо) #}
    {% if order.status == 'shipped' and order.shipping_ttn %}
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'b2b:order_np_label' order.id %}">Етикетка 10×10</a>
    {% endif %}
  </div>
{% endif %}
  {% if request.user.is_staff and order.status == 'shipped' and order.shipping_ttn %}
    <a class="btn btn-outline-secondary" href="{% url 'b2b:order_np_label' order.id %}">Етикетка 10×10</a>
  {% endif %}
</p>

{% if not request.user.is_staff %}
  {% if order.status == 'draft' or order.status == 'cancelled' %}
    <form method="post" action="{% url 'b2b:order_delete' order.id %}"
          onsubmit="return confirm('Видалити це замовлення?');">
      {% csrf_token %}
      <button class="btn btn-outline-danger">Видалити замовлення</button>
    </form>
  {% endif %}
{% endif %}

{% endblock %}

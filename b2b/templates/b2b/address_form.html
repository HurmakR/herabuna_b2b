{% extends "b2b/base.html" %}
{% block content %}
<h2>{% if is_edit %}Редагувати адресу{% else %}Нова адреса{% endif %}</h2>

<form method="post">
  {% csrf_token %}

  <table>
    <tr>
      <th>Назва (мітка)</th>
      <td><input type="text" name="title" value="{{ form.instance.title|default_if_none:'' }}" required></td>
    </tr>

    <tr>
      <th>Місто (НП)</th>
      <td>
        <input type="text" id="city_search" placeholder="Почніть вводити місто" autocomplete="off"
               value="{{ form.instance.city_name|default_if_none:'' }}" required list="city_list" style="min-width:360px;">
        <datalist id="city_list"></datalist>

        <input type="hidden" name="city_name" id="city_name" value="{{ form.instance.city_name|default_if_none:'' }}">
        <input type="hidden" name="city_ref"  id="city_ref"  value="{{ form.instance.city_ref|default_if_none:'' }}">
      </td>
    </tr>

    <tr>
      <th>Відділення (НП)</th>
      <td>
        <input type="text" id="wh_search" placeholder="Оберіть місто, далі введіть № або назву відділення"
               autocomplete="off" value="{{ form.instance.warehouse_name|default_if_none:'' }}" required
               list="wh_list" style="min-width:360px;">
        <datalist id="wh_list"></datalist>

        <input type="hidden" name="warehouse_name" id="warehouse_name" value="{{ form.instance.warehouse_name|default_if_none:'' }}">
        <input type="hidden" name="warehouse_ref"  id="warehouse_ref"  value="{{ form.instance.warehouse_ref|default_if_none:'' }}">
      </td>
    </tr>

    <tr>
      <th>Отримувач</th>
      <td><input type="text" name="recipient_name" value="{{ form.instance.recipient_name|default_if_none:'' }}" required></td>
    </tr>
    <tr>
      <th>Телефон</th>
      <td><input type="text" name="recipient_phone" value="{{ form.instance.recipient_phone|default_if_none:'' }}" required></td>
    </tr>
    <tr>
      <th>За замовчуванням</th>
      <td>
        <label>
          <input type="checkbox" name="is_default" {% if form.instance.is_default %}checked{% endif %}>
          Використовувати як основну адресу
        </label>
      </td>
    </tr>
  </table>

  <button class="btn" type="submit">Зберегти</button>
  <a class="btn" href="{% url 'b2b:address_list' %}">Скасувати</a>
</form>

<script>
// Simple client-side cache of last results to map 'name' -> 'ref'
const NP = {
  cities: new Map(),
  whs: new Map(),
};

const cityInput = document.getElementById('city_search');
const cityName = document.getElementById('city_name');
const cityRef  = document.getElementById('city_ref');
const cityList = document.getElementById('city_list');

const whInput = document.getElementById('wh_search');
const whName  = document.getElementById('warehouse_name');
const whRef   = document.getElementById('warehouse_ref');
const whList  = document.getElementById('wh_list');

function debounce(fn, ms) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
}

async function fetchJSON(url) {
  const r = await fetch(url, {headers: {"X-Requested-With":"XMLHttpRequest"}});
  if (!r.ok) return {results: []};
  return r.json();
}

// Load cities by query
const loadCities = debounce(async () => {
  const q = (cityInput.value || '').trim();
  if (!q) { cityList.innerHTML=''; return; }
  const data = await fetchJSON(`{% url 'b2b:np_cities' %}?q=${encodeURIComponent(q)}`);
  NP.cities.clear();
  cityList.innerHTML = '';
  (data.results || []).forEach(row => {
    NP.cities.set(row.name, row.ref);
    const opt = document.createElement('option');
    opt.value = row.name;
    cityList.appendChild(opt);
  });
}, 250);

// When city chosen: set hidden name/ref and reset warehouses
cityInput.addEventListener('input', () => {
  loadCities();
});
cityInput.addEventListener('change', async () => {
  const name = cityInput.value.trim();
  const ref = NP.cities.get(name) || '';
  cityName.value = name;
  cityRef.value  = ref;

  // reset warehouse fields
  whInput.value = '';
  whName.value = '';
  whRef.value = '';
  whList.innerHTML = '';

  // optional: pre-load top warehouses in this city
  if (ref) {
    const data = await fetchJSON(`{% url 'b2b:np_warehouses' %}?city_ref=${encodeURIComponent(ref)}`);
    NP.whs.clear();
    whList.innerHTML = '';
    (data.results || []).forEach(row => {
      NP.whs.set(row.name, row.ref);
      const opt = document.createElement('option');
      opt.value = row.name;
      whList.appendChild(opt);
    });
  }
});

// Load warehouses by query + selected city_ref
const loadWarehouses = debounce(async () => {
  const city = cityRef.value;
  const q = (whInput.value || '').trim();
  if (!city) return; // wait until city selected
  const url = `{% url 'b2b:np_warehouses' %}?city_ref=${encodeURIComponent(city)}&q=${encodeURIComponent(q)}`;
  const data = await fetchJSON(url);
  NP.whs.clear();
  whList.innerHTML = '';
  (data.results || []).forEach(row => {
    NP.whs.set(row.name, row.ref);
    const opt = document.createElement('option');
    opt.value = row.name;
    whList.appendChild(opt);
  });
}, 250);

whInput.addEventListener('input', () => {
  loadWarehouses();
});
whInput.addEventListener('change', () => {
  const name = whInput.value.trim();
  const ref = NP.whs.get(name) || '';
  whName.value = name;
  whRef.value = ref;
});
</script>
{% endblock %}
